#!/bin/sh

topdir=$(cd $(dirname $0)/.. && pwd)

. $topdir/config/admin.cfg || exit 1

if [ -z "$1" ]; then
	echo "*** ERROR ***: Too few arugments..."
	echo "Usage: $0 REPOS_NAME"
	echo "       $0 REPOS_NAME JIRA_PROJ_KEY [...]"
	exit 1
fi

name=$1

shift

if [ -z "$1" ]; then
	# Redmine
	prefix='#'
	bt_url="$SVN_URL_REDMINE/issues/%BUGID%"
	bt_pat=$prefix'\d+'"
"'\d+'
else
	# JIRA
	prefix='('$1

	shift

	while [ "$1" != "" ]; do
		prefix=$prefix'|'$1
		shift
	done

	prefix=$prefix')'-

	bt_url="$SVN_URL_JIRA/browse/%BUGID%"
	bt_pat=$prefix'\d+'"
"$prefix'\d+'
fi

if [ -d $SVN_REPOS/$name ]; then
	echo "*** WARNING ***: $SVN_REPOS/$name: Repository already exists..."
	exit 0
fi

tmpdir=`mktemp -d`

# Creates Subversion repository
svnadmin create $SVN_REPOS/$name || exit 1

# Initializes repository
svn co file:///$SVN_REPOS/$name $tmpdir || exit 1
svn mkdir $tmpdir/trunk $tmpdir/branches $tmpdir/tags || exit 1
svn propset bugtraq:url $bt_url $tmpdir/trunk || exit 1
svn propset bugtraq:logregex "$bt_pat" $tmpdir/trunk || exit 1
svn commit --username=$SVN_USER -m '' $tmpdir || exit 1
rm -rf $tmpdir

# Creates hook script
hook=$SVN_REPOS/$name/hooks/pre-commit
cat <<'EOF' | sed "s/@PREFIX@/$prefix/" > $hook
#!/bin/sh

REPOS="$1"
TXN="$2"
PREFIX="@PREFIX@"

SVNLOOK=/usr/bin/svnlook
$SVNLOOK log -t "$TXN" "$SVN_REPOS" | egrep "$PREFIX"'[1-9][0-9]*' > /dev/null

if [ "$?" != "0" ]; then
	echo "No issue number" >&2
	exit 1
fi

exit 0
EOF

chmod 755 $hook

# Changes ownerships
chown -R $SVN_OWNER:$SVN_GROUP $SVN_REPOS/$name || exit 1

echo "Completed!"
