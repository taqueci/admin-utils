#!/bin/sh

# Usage: git-backup.sh [BACKUPDIR] [TARGET] ...

if [ -f /etc/admin-utils.conf ]; then
	. /etc/admin-utils.conf || exit 1
else
	topdir=$(cd $(dirname $0)/.. && pwd)
	. $topdir/config/admin-utils.conf || exit 1
	ADMIN_UTILS_BIN=$topdir/bin
	ADMIN_UTILS_LIB=$topdir/lib
	ADMIN_UTILS_SCRIPT=$topdir/script
fi


week=`date +%w`

if [ $week = "0" ]; then
	subdir=weekly/w`date +%02W`
else
	subdir=daily/d`date +%02d`
fi

if [ -z "$1" ]; then
	backupdir=$admin_git_backup_dir/$subdir
else
	backupdir=$1/$subdir
fi

if [ -z "$2" ]; then
	targets=$admin_git_backup_targets
else
	shift
	targets=$@
fi

test -d $backupdir || mkdir -p $backupdir || exit 1

for t in $targets; do
	repos=$backupdir/$admin_git_backup_prefix`basename $t`

	if [ -d $repos ]; then
		echo "Synchronizing Git repository from $t to $repos"
		(cd $repos && git fetch --all -q)
	else
		echo "Cloning Git repository from $t to $repos"
		git clone --mirror -q $t $repos
	fi
done

echo "Completed!"
